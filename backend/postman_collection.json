{
  "info": {
    "_postman_id": "risk-assessment-api",
    "name": "Risk Assessment Survey API",
    "description": "API collection for the Risk Assessment Survey System.\n\n## Authentication\n\nAdmin endpoints require API key authentication via the `X-API-Key` header.\n\n## Base URL\n\nSet the `base_url` variable to your API server (default: http://localhost:8000).\n\n## Hierarchy\n\nType → Group → Questions (Эрсдэлийн төрөл → Бүлэг → Асуултууд)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8000",
      "type": "string"
    },
    {
      "key": "api_key",
      "value": "your-api-key-here",
      "type": "string"
    },
    {
      "key": "type_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "group_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "question_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "respondent_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "odoo_id",
      "value": "res.partner_42",
      "type": "string"
    },
    {
      "key": "assessment_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "assessment_token",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Health",
      "item": [
        {
          "name": "Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/health",
              "host": ["{{base_url}}"],
              "path": ["health"]
            },
            "description": "Check application health including database connectivity."
          }
        },
        {
          "name": "Readiness Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/ready",
              "host": ["{{base_url}}"],
              "path": ["ready"]
            },
            "description": "Kubernetes-style readiness probe."
          }
        },
        {
          "name": "Liveness Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/live",
              "host": ["{{base_url}}"],
              "path": ["live"]
            },
            "description": "Kubernetes-style liveness probe."
          }
        }
      ]
    },
    {
      "name": "Admin - Questionnaire Types",
      "item": [
        {
          "name": "Create Type",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('type_id', jsonData.id);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"ГАЛЫН АЮУЛГҮЙ БАЙДАЛ\",\n  \"scoring_method\": \"SUM\",\n  \"threshold_high\": 80,\n  \"threshold_medium\": 50,\n  \"weight\": 1.0\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/types",
              "host": ["{{base_url}}"],
              "path": ["admin", "types"]
            },
            "description": "Create a new questionnaire type (Эрсдэлийн төрөл)."
          }
        },
        {
          "name": "List Types",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/types?page=1&page_size=20",
              "host": ["{{base_url}}"],
              "path": ["admin", "types"],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "page_size",
                  "value": "20"
                },
                {
                  "key": "is_active",
                  "value": "true",
                  "disabled": true
                }
              ]
            },
            "description": "List all questionnaire types with pagination."
          }
        },
        {
          "name": "Get Type",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/types/{{type_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "types", "{{type_id}}"]
            },
            "description": "Get a questionnaire type by ID."
          }
        },
        {
          "name": "Update Type",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"ГАЛЫН АЮУЛГҮЙ БАЙДАЛ (шинэчилсэн)\",\n  \"threshold_high\": 85,\n  \"is_active\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/types/{{type_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "types", "{{type_id}}"]
            },
            "description": "Update a questionnaire type."
          }
        }
      ]
    },
    {
      "name": "Admin - Question Groups",
      "item": [
        {
          "name": "Create Group",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('group_id', jsonData.id);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"type_id\": \"{{type_id}}\",\n  \"name\": \"Галын хор\",\n  \"display_order\": 1,\n  \"weight\": 1.0\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/groups",
              "host": ["{{base_url}}"],
              "path": ["admin", "groups"]
            },
            "description": "Create a new question group (Бүлэг) within a questionnaire type."
          }
        },
        {
          "name": "List Groups by Type",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/groups?type_id={{type_id}}&page=1&page_size=20",
              "host": ["{{base_url}}"],
              "path": ["admin", "groups"],
              "query": [
                {
                  "key": "type_id",
                  "value": "{{type_id}}"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "page_size",
                  "value": "20"
                },
                {
                  "key": "is_active",
                  "value": "true",
                  "disabled": true
                }
              ]
            },
            "description": "List all question groups for a questionnaire type."
          }
        },
        {
          "name": "Get Group",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/groups/{{group_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "groups", "{{group_id}}"]
            },
            "description": "Get a question group by ID."
          }
        },
        {
          "name": "Update Group",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Галын хор (шинэчилсэн)\",\n  \"weight\": 1.5,\n  \"is_active\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/groups/{{group_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "groups", "{{group_id}}"]
            },
            "description": "Update a question group."
          }
        },
        {
          "name": "Deactivate Group",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/groups/{{group_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "groups", "{{group_id}}"]
            },
            "description": "Deactivate a question group (soft delete). Deactivated groups are excluded from new assessment snapshots."
          }
        }
      ]
    },
    {
      "name": "Admin - Questions",
      "item": [
        {
          "name": "Create Question",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('question_id', jsonData.id);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"group_id\": \"{{group_id}}\",\n  \"text\": \"Лац түгжээ, шаланк, резин жийрэг нь бүрэн бүтэн эсэх\",\n  \"display_order\": 1,\n  \"weight\": 1.0,\n  \"is_critical\": false\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/questions",
              "host": ["{{base_url}}"],
              "path": ["admin", "questions"]
            },
            "description": "Create a new question for a question group. Questions now belong to groups, not directly to types."
          }
        },
        {
          "name": "List Questions by Group",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/questions?group_id={{group_id}}&page=1&page_size=20",
              "host": ["{{base_url}}"],
              "path": ["admin", "questions"],
              "query": [
                {
                  "key": "group_id",
                  "value": "{{group_id}}"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "page_size",
                  "value": "20"
                },
                {
                  "key": "is_active",
                  "value": "true",
                  "disabled": true
                }
              ]
            },
            "description": "List questions for a question group."
          }
        },
        {
          "name": "Get Question",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/questions/{{question_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "questions", "{{question_id}}"]
            },
            "description": "Get a question by ID including its options."
          }
        },
        {
          "name": "Update Question",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"text\": \"Лац түгжээ, шаланк, резин жийрэг нь бүрэн бүтэн байна уу?\",\n  \"is_critical\": true,\n  \"is_active\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/questions/{{question_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "questions", "{{question_id}}"]
            },
            "description": "Update a question."
          }
        },
        {
          "name": "Set Question Options",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"yes\": {\n    \"option_type\": \"YES\",\n    \"score\": 1,\n    \"require_comment\": false,\n    \"require_image\": false,\n    \"comment_min_len\": 0,\n    \"max_images\": 1,\n    \"image_max_mb\": 5\n  },\n  \"no\": {\n    \"option_type\": \"NO\",\n    \"score\": 0,\n    \"require_comment\": true,\n    \"require_image\": false,\n    \"comment_min_len\": 10,\n    \"max_images\": 3,\n    \"image_max_mb\": 5\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/questions/{{question_id}}/options",
              "host": ["{{base_url}}"],
              "path": ["admin", "questions", "{{question_id}}", "options"]
            },
            "description": "Set YES and NO options for a question."
          }
        }
      ]
    },
    {
      "name": "Admin - Assessments",
      "item": [
        {
          "name": "Create Assessment (with Odoo respondent)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('assessment_id', jsonData.id);",
                  "    pm.collectionVariables.set('respondent_id', jsonData.respondent_id);",
                  "    // Extract token from URL",
                  "    var url = jsonData.url;",
                  "    var token = url.split('/a/')[1];",
                  "    if (token) {",
                  "        pm.collectionVariables.set('assessment_token', token);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              },
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"respondent\": {\n    \"odoo_id\": \"{{odoo_id}}\",\n    \"name\": \"Монгол Банк ХХК\",\n    \"kind\": \"ORG\",\n    \"registration_no\": \"1234567\"\n  },\n  \"employee_id\": \"hr.employee_15\",\n  \"employee_name\": \"Батболд Д.\",\n  \"selected_type_ids\": [\"{{type_id}}\"],\n  \"expires_in_days\": 30\n}"
            },
            "url": {
              "raw": "{{base_url}}/admin/assessments",
              "host": ["{{base_url}}"],
              "path": ["admin", "assessments"]
            },
            "description": "Create an assessment with inline respondent data from Odoo. The system creates or matches the respondent by odoo_id, stores optional employee data, and returns the assessment link."
          }
        },
        {
          "name": "List Assessments",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/assessments?page=1&page_size=20",
              "host": ["{{base_url}}"],
              "path": ["admin", "assessments"],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "page_size",
                  "value": "20"
                },
                {
                  "key": "respondent_id",
                  "value": "{{respondent_id}}",
                  "disabled": true
                },
                {
                  "key": "odoo_id",
                  "value": "{{odoo_id}}",
                  "description": "Filter by respondent Odoo ID",
                  "disabled": true
                },
                {
                  "key": "employee_id",
                  "value": "hr.employee_15",
                  "description": "Filter by Odoo employee ID",
                  "disabled": true
                },
                {
                  "key": "status",
                  "value": "PENDING",
                  "disabled": true
                }
              ]
            },
            "description": "List all assessments with pagination and filtering. Supports filtering by odoo_id (respondent Odoo ID) and employee_id."
          }
        },
        {
          "name": "Get Assessment",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/assessments/{{assessment_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "assessments", "{{assessment_id}}"]
            },
            "description": "Get an assessment by ID."
          }
        },
        {
          "name": "Get Assessment Results",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/assessments/{{assessment_id}}/results?breakdown=true",
              "host": ["{{base_url}}"],
              "path": ["admin", "assessments", "{{assessment_id}}", "results"],
              "query": [
                {
                  "key": "breakdown",
                  "value": "true"
                }
              ]
            },
            "description": "Get assessment results with hierarchical scores (Group → Type → Overall), submission contact info, and optional answer breakdown."
          }
        }
      ]
    },
    {
      "name": "Public - Assessment",
      "item": [
        {
          "name": "Get Assessment Form",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/a/{{assessment_token}}",
              "host": ["{{base_url}}"],
              "path": ["a", "{{assessment_token}}"]
            },
            "description": "Get assessment form data for a respondent. Returns the hierarchical Type → Group → Questions structure from the snapshot."
          }
        },
        {
          "name": "Upload Image Attachment",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "question_id",
                  "value": "{{question_id}}",
                  "type": "text"
                },
                {
                  "key": "file",
                  "type": "file",
                  "src": ""
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/a/{{assessment_token}}/upload",
              "host": ["{{base_url}}"],
              "path": ["a", "{{assessment_token}}", "upload"]
            },
            "description": "Upload an image attachment for a question. The returned attachment ID should be included in the submission."
          }
        },
        {
          "name": "Save Draft",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"answers\": [\n    {\n      \"question_id\": \"{{question_id}}\",\n      \"selected_option\": \"YES\",\n      \"comment\": \"Тайлбар\"\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{base_url}}/a/{{assessment_token}}/draft",
              "host": ["{{base_url}}"],
              "path": ["a", "{{assessment_token}}", "draft"]
            },
            "description": "Save or update draft answers for an assessment. Uses PUT with upsert semantics. Auto-save calls this every 30s, or user clicks Хадгалах button."
          }
        },
        {
          "name": "Load Draft",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/a/{{assessment_token}}/draft",
              "host": ["{{base_url}}"],
              "path": ["a", "{{assessment_token}}", "draft"]
            },
            "description": "Load saved draft for an assessment. Returns 204 No Content if no draft exists."
          }
        },
        {
          "name": "Submit Assessment",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"contact\": {\n    \"last_name\": \"Батбаяр\",\n    \"first_name\": \"Дорж\",\n    \"email\": \"dorj@example.com\",\n    \"phone\": \"99001234\",\n    \"position\": \"Аюулгүй байдлын менежер\"\n  },\n  \"answers\": [\n    {\n      \"question_id\": \"{{question_id}}\",\n      \"selected_option\": \"YES\",\n      \"comment\": null,\n      \"attachment_ids\": []\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{base_url}}/a/{{assessment_token}}/submit",
              "host": ["{{base_url}}"],
              "path": ["a", "{{assessment_token}}", "submit"]
            },
            "description": "Submit assessment answers with contact info (Хариулагч). Validates all answers, calculates hierarchical scores (Group → Type → Overall), and returns results."
          }
        }
      ]
    },
    {
      "name": "Admin - Cleanup",
      "item": [
        {
          "name": "Cleanup Orphaned Drafts",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/cleanup/drafts?older_than_days=30&include_images=false&dry_run=true",
              "host": ["{{base_url}}"],
              "path": ["admin", "cleanup", "drafts"],
              "query": [
                {
                  "key": "older_than_days",
                  "value": "30",
                  "description": "Only cleanup drafts for assessments expired more than N days ago"
                },
                {
                  "key": "include_images",
                  "value": "false",
                  "description": "Also delete orphaned images from storage"
                },
                {
                  "key": "dry_run",
                  "value": "true",
                  "description": "Preview what would be deleted without actually deleting"
                }
              ]
            },
            "description": "Delete draft records for expired assessments. Supports dry_run mode to preview without deleting. Optionally also cleans up orphaned images."
          }
        },
        {
          "name": "Cleanup Orphaned Images",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/cleanup/images?older_than_days=30&dry_run=true",
              "host": ["{{base_url}}"],
              "path": ["admin", "cleanup", "images"],
              "query": [
                {
                  "key": "older_than_days",
                  "value": "30",
                  "description": "Only cleanup images uploaded more than N days ago"
                },
                {
                  "key": "dry_run",
                  "value": "true",
                  "description": "Preview what would be deleted without actually deleting"
                }
              ]
            },
            "description": "Delete images from storage that are not referenced by any answer. Supports dry_run mode to preview."
          }
        }
      ]
    }
  ]
}
